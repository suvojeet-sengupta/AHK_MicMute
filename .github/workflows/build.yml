name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.3.5
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.3.5)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $version = "${{ github.event.inputs.version }}"
          } else {
            $version = "${{ github.ref_name }}"
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"

      - name: Download Bass audio library
        shell: pwsh
        run: |
          Invoke-WebRequest "https://www.un4seen.com/files/bass24.zip" -OutFile ".\bass24.zip"
          Expand-Archive -Path ".\bass24.zip" -DestinationPath ".\bass24\"
          Remove-Item -Path ".\bass24.zip" -Force
          Copy-Item -Path ".\bass24\x64\bass.dll" -Destination ".\src\Lib\bass.dll" -Force

      - name: Install ahkpm and dependencies
        shell: pwsh
        run: |
          $cwd = (Get-Item .).FullName
          Invoke-WebRequest "https://github.com/joshuacc/ahkpm/releases/download/0.7.0/ahkpm-0.7.0.msi" -OutFile "$cwd\ahkpm.msi"
          Start-Process "MSIEXEC" -ArgumentList "/a `"$cwd\ahkpm.msi`" /qn TARGETDIR=`"$cwd\ahkpmDir`"" -Wait -NoNewWindow
          Start-Process "$cwd\ahkpmDir\ahkpm\ahkpm.exe" -ArgumentList "install" -WorkingDirectory "$cwd" -Wait -NoNewWindow

      - name: Compile MicMute.exe
        uses: SaifAqqad/GitHub-Action-Ahk2Exe@v1.0.3
        with:
          in: '.\src\MicMute.ahk'
          out: '.\MicMute.exe'

      - name: Calculate SHA256 hash
        shell: pwsh
        run: |
          $hash = (Get-FileHash '.\MicMute.exe' -Algorithm SHA256).Hash
          echo $hash | Tee-Object -FilePath .\MicMute.sha256
          echo "SHA256: $hash"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: MicMute ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## MicMute ${{ steps.get_version.outputs.VERSION }}
            
            ### Installation
            1. Download `MicMute.exe`
            2. Run it - it will appear in your system tray
            3. Right-click the tray icon to configure
            
            ### SHA256 Checksum
            ```
            ${{ steps.get_version.outputs.VERSION }}
            ```
            See `MicMute.sha256` for the full hash.
          draft: false
          prerelease: false
          files: |
            MicMute.exe
            MicMute.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MicMute-${{ steps.get_version.outputs.VERSION }}
          path: |
            MicMute.exe
            MicMute.sha256
          retention-days: 30
